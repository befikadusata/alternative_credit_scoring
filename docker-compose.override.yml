# Override file to fix MLflow and API service configuration for integration tests
version: '3.8'

services:
  mlflow:
    # Install curl so health check works
    command: >
      bash -c "
        apt-get update &&
        apt-get install -y curl &&
        pip install mlflow psycopg2-binary boto3 &&
        mlflow server
          --host 0.0.0.0
          --port 5000
          --backend-store-uri postgresql://mlflow:mlflow@postgres:5432/mlflow
          --default-artifact-root s3://mlflow-artifacts
          --serve-artifacts
          --allow-origin '*'
      "
    # Use a simple health check that doesn't rely on external tools
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:5000/"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s  # Allow more time for initial startup

  api:
    # Change dependency to not require mlflow to be healthy, just running
    depends_on:
      mlflow:
        condition: service_started  # Changed from service_healthy
      redis:
        condition: service_healthy